{
  if (getArguments() == null || !getArguments().containsKey("builder"))   throw new IllegalStateException("ColorChooserDialog should be created using its Builder interface.");
  generateColors();
  final int preselectColor=getBuilder().mPreselect;
  boolean foundPreselectColor=false;
  if (preselectColor != 0) {
    for (int topIndex=0; topIndex < mColorsTop.length; topIndex++) {
      if (mColorsTop[topIndex] == preselectColor) {
        foundPreselectColor=true;
        topIndex(topIndex);
        if (getBuilder().mAccentMode) {
          subIndex(2);
        }
 else         if (mColorsSub != null) {
          findSubIndexForColor(topIndex,preselectColor);
        }
 else {
          subIndex(5);
        }
        break;
      }
      if (mColorsSub != null) {
        for (int subIndex=0; subIndex < mColorsSub[topIndex].length; subIndex++) {
          if (mColorsSub[topIndex][subIndex] == preselectColor) {
            foundPreselectColor=true;
            topIndex(topIndex);
            subIndex(subIndex);
            break;
          }
        }
        if (foundPreselectColor)         break;
      }
    }
  }
  mCircleSize=getResources().getDimensionPixelSize(R.dimen.md_colorchooser_circlesize);
  final Builder builder=getBuilder();
  MaterialDialog dialog=new MaterialDialog.Builder(getActivity()).title(getTitle()).autoDismiss(false).customView(R.layout.md_dialog_colorchooser,false).negativeText(builder.mCancelBtn).positiveText(builder.mDoneBtn).neutralText(builder.mAllowUserCustom ? builder.mCustomBtn : 0).onPositive(new MaterialDialog.SingleButtonCallback(){
    @Override public void onClick(    @NonNull MaterialDialog dialog,    @NonNull DialogAction which){
      mCallback.onColorSelection(ColorChooserDialog.this,getSelectedColor());
      dismiss();
    }
  }
).onNegative(new MaterialDialog.SingleButtonCallback(){
    @Override public void onClick(    @NonNull MaterialDialog dialog,    @NonNull DialogAction which){
      if (isInSub()) {
        dialog.setActionButton(DialogAction.NEGATIVE,getBuilder().mCancelBtn);
        isInSub(false);
        invalidate();
      }
 else {
        dialog.cancel();
      }
    }
  }
).onNeutral(new MaterialDialog.SingleButtonCallback(){
    @Override public void onClick(    @NonNull MaterialDialog dialog,    @NonNull DialogAction which){
      toggleCustom(dialog);
    }
  }
).showListener(new DialogInterface.OnShowListener(){
    @Override public void onShow(    DialogInterface dialog){
      invalidateDynamicButtonColors();
    }
  }
).build();
  final View v=dialog.getCustomView();
  mGrid=(GridView)v.findViewById(R.id.grid);
  if (builder.mAllowUserCustom) {
    mSelectedCustomColor=preselectColor;
    mColorChooserCustomFrame=v.findViewById(R.id.colorChooserCustomFrame);
    mCustomColorHex=(EditText)v.findViewById(R.id.hexInput);
    mCustomColorIndicator=v.findViewById(R.id.colorIndicator);
    mCustomSeekA=(SeekBar)v.findViewById(R.id.colorA);
    mCustomSeekAValue=(TextView)v.findViewById(R.id.colorAValue);
    mCustomSeekR=(SeekBar)v.findViewById(R.id.colorR);
    mCustomSeekRValue=(TextView)v.findViewById(R.id.colorRValue);
    mCustomSeekG=(SeekBar)v.findViewById(R.id.colorG);
    mCustomSeekGValue=(TextView)v.findViewById(R.id.colorGValue);
    mCustomSeekB=(SeekBar)v.findViewById(R.id.colorB);
    mCustomSeekBValue=(TextView)v.findViewById(R.id.colorBValue);
    if (!builder.mAllowUserCustomAlpha) {
      v.findViewById(R.id.colorALabel).setVisibility(View.GONE);
      mCustomSeekA.setVisibility(View.GONE);
      mCustomSeekAValue.setVisibility(View.GONE);
      mCustomColorHex.setHint("2196F3");
      mCustomColorHex.setFilters(new InputFilter[]{new InputFilter.LengthFilter(6)});
    }
 else {
      mCustomColorHex.setHint("FF2196F3");
      mCustomColorHex.setFilters(new InputFilter[]{new InputFilter.LengthFilter(8)});
    }
    if (!foundPreselectColor) {
      toggleCustom(dialog);
    }
  }
  invalidate();
  return dialog;
}
